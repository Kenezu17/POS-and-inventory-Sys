<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Item with Barcode</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .modal {
      background: #fff;
      padding: 20px;
      width: 350px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    #reader {
      width: 100%;
      height: 250px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      display: none; /* hidden by default */
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Popup panel -->
  <div class="modal">
    <h2>Scan Item</h2>

    <!-- Camera live preview -->
    <div id="reader"></div>
    <p id="cameraStatus" style="color:red; font-size:14px;"></p>

    <!-- Form -->
    <label>Barcode</label>
    <input type="text" id="barcode" readonly>

    <label>Quantity</label>
    <input type="number" id="quantity" placeholder="Enter amount">

    <label>Unit</label>
    <select id="unit">
      <option value=""></option>
      <option value="pcs">pcs</option>
      <option value="kg">kg</option>
      <option value="liters">liters</option>
    </select>

    <button id="saveBtn">Save Item</button>
    <button id="closeBtn" style="background:#f55; color:white;">Close</button>
  </div>

  <!-- Load Barcode Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
    const barcodeInput = document.getElementById("barcode");
    const readerDiv = document.getElementById("reader");
    const cameraStatus = document.getElementById("cameraStatus");

    let html5QrCode;

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 200 },
        (decodedText) => {
          barcodeInput.value = decodedText;
        }
      ).then(() => {
        // ✅ Camera started → show preview
        readerDiv.style.display = "block";
        cameraStatus.textContent = "Camera is open";
        cameraStatus.style.color = "green";
      }).catch(err => {
        // ❌ Camera failed → hide preview
        readerDiv.style.display = "none";
        cameraStatus.textContent = "Camera not available or permission denied.";
        cameraStatus.style.color = "red";
        console.error("Camera error:", err);
      });
    }

    // Start scanning on page load
    window.onload = startScanner;

    // Save button
    document.getElementById("saveBtn").addEventListener("click", () => {
      alert("Item Saved!\nBarcode: " + barcodeInput.value +
            "\nQuantity: " + document.getElementById("quantity").value +
            "\nUnit: " + document.getElementById("unit").value);
    });

    // Close button
    document.getElementById("closeBtn").addEventListener("click", () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = "none";
          cameraStatus.textContent = "Camera closed.";
        });
      }
    });
  </script>

</body>
</html>
